<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Claim Assistant Support</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
  <link rel="stylesheet" href="../static/css/style.css">
</head>
<body>
  <div class="top-bar d-flex justify-content-between align-items-center">
            <div class="col-9 d-flex align-items-center">
                <img src="/static/icons/3kt_logo.png" alt="3K Technologies" width="160">
                <span class="ms-3 fw-semibold fs-5">ASK Health Insurance</span>
            </div>
            <div class="col-3 text-end">
                <span class="version-info me-3">Version 0.0.1</span>
                <img src="/static/icons/user.png" alt="user-icon" width="24">
            </div>
        </div>
  <div class="chat-container">
    <div class="chat-header">ASK Health Insurance</div>
    <div id="chat">
      <!-- <div class="message bot">
        <div class="message-avatar">ðŸ¤–</div>
        <div class="message-bubble">Hi! I'm here to help you with your banking needs. How can I assist you today?</div>
      </div> -->
    </div>

    <div class="input-container">
  <input id="input" type="text" placeholder="Type your message..." autocomplete="off" />
  <button id="micBtn" title="Tap to Speak"><img src="../static/icons/microphone.png" style="width: 20px;"></button>
  <button id="send">Send</button>
</div>
  </div>
<script>
  const micBtn = document.getElementById("micBtn");
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = new SpeechRecognition();
  recognition.continuous = false;
  recognition.interimResults = false;
  recognition.lang = "en-US";
  let recognitionTimeout;
  micBtn.onclick = () => {
  input.value = "";
  recognition.start();
  micBtn.classList.add('mic-listening');
  micBtn.disabled = true;
  recognitionTimeout = setTimeout(() => {
      recognition.stop();
    }, 6000);
  };
  recognition.onresult = function (event) {
    const transcript = event.results[0][0].transcript;
    input.value = transcript;
    sendMessage();
  };
  recognition.onerror = function (event) {
    console.error("Speech recognition error", event.error);
    showSystemMessage("ðŸŽ¤ Mic error: " + event.error, "error");
  };
  recognition.onend = () => {
    micBtn.classList.remove('mic-listening');
    micBtn.disabled = false;
    clearTimeout(recognitionTimeout);
  };
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
<script src="https://aldo.irevomm.com/js/my_aldo_button.js?v=2.7.44"></script>
<script>
    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    const send = document.getElementById('send');
    
    let sessionId = null;
    let ws = null;

    function connectWebSocket() {
      const wsUrl = window.location.protocol === 'https:'
        ? `wss://${window.location.host}/ws/chat`
        : `ws://${window.location.host}/ws/chat`;
      
      ws = new WebSocket(wsUrl);
      
      ws.onopen = () => {
        console.log("WebSocket connected");
        send.disabled = false;
        showSystemMessage("Connected to support chat", "success");
      };

      ws.onmessage = (event) => {
        handleWebSocketMessage(event);
      };

      ws.onclose = () => {
        console.log("WebSocket disconnected");
        showSystemMessage("Connection lost. Attempting to reconnect...", "error");
        send.disabled = true;
        setTimeout(connectWebSocket, 3000);
      };

      ws.onerror = (err) => {
        console.error('WebSocket error:', err);
        showSystemMessage("Connection error. Please refresh if issues persist.", "error");
        send.disabled = true;
      };
    }

    function handleWebSocketMessage(event) {
      hideTypingIndicator();
      let data = {};
      try {
        data = JSON.parse(event.data);
      } catch {
        data = { message: event.data, role: 'bot' };
      }

      if (data.session_id) {
        sessionId = data.session_id;
      }

      if (data.role === 'system') {
        showSystemMessage(data.message, data.error ? "error" : "info");
        return;
      }

      setTimeout(() => {
        addMessage(data.message, data.role || 'bot');
        if (data.show_escalation_buttons) {
          showEscalationButtons();
        }
      }, 300);
    }

    function addMessage(text, role) {
  const msgDiv = document.createElement('div');
  msgDiv.className = `message ${role}`;

  const avatar = document.createElement('div');
  avatar.className = 'message-avatar';

  const img = document.createElement('img');
  img.src = role === 'user' ? '../static/icons/user.png' : '../static/icons/ask_icon.png';
  img.alt = 'avatar';
  img.style.width = '25px';
  img.style.height = '25px';
  img.style.borderRadius = '50%';
  avatar.appendChild(img);

  const bubble = document.createElement('div');
  bubble.className = 'message-bubble';
  bubble.textContent = text;

  msgDiv.appendChild(avatar);
  msgDiv.appendChild(bubble);
  chat.appendChild(msgDiv);
  scrollToBottom();

  if (role === 'bot' || role === 'assistant' || role === 'system') {
    speakMessage(text);
  }
}

    function showSystemMessage(text, role, type = "info") {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'message bot';
      msgDiv.style.opacity = '0.8';

      const avatar = document.createElement('div');
      avatar.className = 'message-avatar';
      avatar.textContent = type === 'error' ? 'âš ï¸' : type === 'success' ? 'âœ…' : 'â„¹ï¸';

      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      bubble.style.background = type === 'error' ? '#ffebee' : type === 'success' ? '#e8f5e8' : '#e3f2fd';
      bubble.style.borderColor = type === 'error' ? '#f44336' : type === 'success' ? '#4caf50' : '#2196f3';
      bubble.textContent = text;

      msgDiv.appendChild(avatar);
      msgDiv.appendChild(bubble);
      chat.appendChild(msgDiv);
      scrollToBottom();
      if (role === 'bot' || role === 'assistant' || role === 'system') {
        speakMessage(text);
      }
    }

    function speakMessage(text) {
  if (!window.speechSynthesis) return;

  const synth = window.speechSynthesis;
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = 'en-US';
  utterance.rate = 0.9;
  utterance.pitch = 1;
  utterance.volume = 1;

  const voices = synth.getVoices();

  // Prefer a soft male voice if available
  const preferredVoice = voices.find(voice =>
    voice.lang.startsWith('en') &&
    voice.name.toLowerCase().includes('male')
  ) || voices.find(voice =>
    voice.lang.startsWith('en') &&
    voice.name.toLowerCase().includes('english')
  );

  if (preferredVoice) {
    utterance.voice = preferredVoice;
    console.log("Using voice:", preferredVoice.name);
  } else {
    console.warn("No preferred voice found, using default.");
  }

  synth.cancel(); // Stop any previous speech
  synth.speak(utterance);
}



    function showTypingIndicator() {
      if (document.getElementById('typing-indicator')) return;
      
      const typing = document.createElement('div');
      typing.className = 'message bot';
      typing.id = 'typing-indicator';

      const avatar = document.createElement('div');
avatar.className = 'message-avatar';

const img = document.createElement('img');
img.src = '../static/icons/ask_icon.png';
img.alt = 'typing-avatar';
img.style.width = '25px';
img.style.height = '25px';
img.style.borderRadius = '50%';
avatar.appendChild(img);

      const bubble = document.createElement('div');
      bubble.className = 'typing-indicator';
      bubble.style.display = 'flex';

      for (let i = 0; i < 3; i++) {
        const dot = document.createElement('div');
        dot.className = 'typing-dot';
        bubble.appendChild(dot);
      }

      typing.appendChild(avatar);
      typing.appendChild(bubble);
      chat.appendChild(typing);
      scrollToBottom();
    }

    function hideTypingIndicator() {
      const typing = document.getElementById('typing-indicator');
      if (typing) typing.remove();
    }

    function showEscalationButtons() {
  const existing = document.getElementById('escalation-buttons');
  if (existing) existing.remove();

  const container = document.createElement('div');
  container.id = 'escalation-buttons';
  container.className = 'escalation-buttons';

  // Video Call Button
  const videoWrapper = document.createElement('div');
  videoWrapper.innerHTML = `
    <div id="aldo_video"
         button-type="aldo-button"
         button-code="eEzZW4x7MNwevdby/JV3FRDNfgpZ16VX0SbKE15EwvY="
         generated-on="07/16/2025, 9:43:28 AM, Asia/Calcutta"
         dn="https://testing.trivenimm.com/html/3kt.html">
    </div>`;
  container.appendChild(videoWrapper);

  // Audio Call Button
  const audioWrapper = document.createElement('div');
  audioWrapper.innerHTML = `
    <div id="aldo_audio"
         button-type="aldo-button"
         button-code="eEzZW4x7MNwevdby/JV3FRDNfgpZ16VX0THKE15EwvY="
         generated-on="07/16/2025, 9:43:44 AM, Asia/Calcutta"
         dn="https://testing.trivenimm.com/html/3kt.html">
    </div>`;
  container.appendChild(audioWrapper);

  // Schedule Callback Button
  const scheduleBtn = document.createElement('button');
  scheduleBtn.className = 'escalation-btn schedule';
  scheduleBtn.innerHTML = `<span class="img_txt">
  <img src="../static/icons/calendar.png" alt="calendar icon" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;">
  Schedule Callback
</button>`;
  scheduleBtn.onclick = () => {
    window.open("https://calendly.com/demo-3ktechnologies/30min", "_blank");
  };
  container.appendChild(scheduleBtn);

  chat.appendChild(container);

    // Load video button script
  const videoScript = document.createElement('script');
  videoScript.src = 'https://aldo.irevomm.com/js/my_aldo_button.js?v=2.7.44';
  videoScript.defer = true;
  videoWrapper.appendChild(videoScript);

  // Load audio button script
  const audioScript = document.createElement('script');
  audioScript.src = 'https://aldo.irevomm.com/js/my_aldo_button.js?v=2.7.44';
  audioScript.defer = true;
  audioWrapper.appendChild(audioScript);

  scrollToBottom();
}

    function scrollToBottom() {
      chat.scrollTop = chat.scrollHeight;
    }

    function sendMessage() {
      const msg = input.value.trim();
      if (!msg || !ws || ws.readyState !== WebSocket.OPEN) return;

      addMessage(msg, 'user');
      showTypingIndicator();

      ws.send(JSON.stringify({
        message: msg,
        user_id: sessionId || 'web-' + Math.random().toString(36).substring(2, 8),
        message_type: 'chat'
      }));

      input.value = '';
      input.focus();
    }

    send.onclick = sendMessage;
    input.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    window.addEventListener('load', () => {
      input.focus();
      connectWebSocket();
    });

    send.disabled = true;
</script>

  <!-- Load escalation handlers -->
  <script type="module">
    import { handleTalkNow } from './static/js/talkNow.js';
    import { handleScheduleCallback } from './static/js/scheduleCallback.js';

    window.handleTalkNow = handleTalkNow;
    window.handleScheduleCallback = handleScheduleCallback;
  </script>
</body>
</html>